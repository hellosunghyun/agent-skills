<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insights Report</title>
    <style>
        :root {
            --bg-color: #f9fafb;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --accent-color: #4f46e5;
            --accent-light: #e0e7ff;
            --success-color: #059669;
            --warning-color: #d97706;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 0.75rem;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #111827;
                --text-primary: #f9fafb;
                --text-secondary: #9ca3af;
                --card-bg: #1f2937;
                --border-color: #374151;
                --accent-color: #818cf8;
                --accent-light: #312e81;
                --success-color: #34d399;
                --warning-color: #fbbf24;
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-stack);
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            padding: 2rem 1rem;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Typography */
        h1, h2, h3, h4 {
            line-height: 1.2;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }

        h1 { font-size: 2.25rem; letter-spacing: -0.025em; }
        h2 { font-size: 1.5rem; letter-spacing: -0.025em; margin-top: 2.5rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border-color); }
        h3 { font-size: 1.125rem; margin-top: 1.5rem; }
        p { margin-bottom: 1rem; }
        
        .text-secondary { color: var(--text-secondary); }
        .text-sm { font-size: 0.875rem; }
        .font-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }
        .report-meta {
            display: inline-block;
            background-color: var(--card-bg);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        /* Cards */
        .card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 1.5rem;
        }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }

        /* Components */
        .pill {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background-color: var(--accent-light);
            color: var(--accent-color);
        }

        .list-disc {
            padding-left: 1.5rem;
        }
        .list-disc li {
            margin-bottom: 0.5rem;
        }

        /* Section Specifics */
        .at-a-glance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .glance-item {
            background: var(--bg-color);
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .glance-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .glance-value {
            font-weight: 500;
        }

        .project-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 0;
        }
        .project-area:last-child { border-bottom: none; }
        .area-count {
            background: var(--bg-color);
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .prompt-box {
            background-color: var(--bg-color);
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.875rem;
            overflow-x: auto;
            border: 1px dashed var(--border-color);
            margin-top: 0.5rem;
            white-space: pre-wrap;
        }

        .fun-moment {
            background: linear-gradient(135deg, var(--accent-light) 0%, var(--card-bg) 100%);
            border-color: var(--accent-color);
        }

        /* Helpers */
        .hidden { display: none; }
        strong { font-weight: 600; color: var(--text-primary); }

        /* Print Styles */
        @media print {
            body { background: white; color: black; padding: 0; }
            .container { max-width: 100%; }
            .card { box-shadow: none; border: 1px solid #ddd; break-inside: avoid; }
            h2 { border-bottom: 2px solid #000; }
            .fun-moment { background: none; border: 1px solid #000; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Insights Report</h1>
            <div class="report-meta">
                Generated on <span id="gen-date">{{GENERATED_DATE}}</span> • {{CLI_TYPE}}
            </div>
            <div id="stats-summary" style="margin-top: 1.5rem; font-size: 0.9rem; color: var(--text-secondary);"></div>
        </header>
        
        <main id="report-content">
            <!-- Content will be injected via JS -->
            <div id="loading" style="text-align: center; padding: 2rem;">Loading report...</div>
        </main>

        <footer style="text-align: center; margin-top: 4rem; color: var(--text-secondary); font-size: 0.875rem;">
            <p>Generated by OpenCode Insights</p>
        </footer>
    </div>

    <!-- Data Injection -->
    <script type="application/json" id="stats-data">{{STATS_JSON}}</script>
    <script type="application/json" id="insights-data">{{INSIGHTS_JSON}}</script>

    <script>
        // --- Utilities ---
        const $ = (id) => document.getElementById(id);
        const escapeHtml = (unsafe) => {
            return (unsafe || '').replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        };

        const parseMarkdown = (text) => {
            if (!text) return '';
            let html = escapeHtml(text);
            // Bold **text**
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // List items - 
            html = html.replace(/^- (.*)$/gm, '• $1');
            // Line breaks
            html = html.replace(/\n/g, '<br>');
            return html;
        };

        const renderSection = (title, contentHTML, extraClasses = '') => {
            if (!contentHTML) return '';
            return `
                <section class="section-block ${extraClasses}">
                    <h2>${title}</h2>
                    <div class="card">
                        ${contentHTML}
                    </div>
                </section>
            `;
        };

        // --- Renderers ---

        function renderStats(stats) {
            if (!stats) return;
            const summary = [];
            if (stats.total_sessions) summary.push(`<strong>${stats.total_sessions}</strong> Sessions`);
            if (stats.total_messages) summary.push(`<strong>${stats.total_messages}</strong> Messages`);
            if (stats.total_duration_minutes) {
                const hours = Math.round(stats.total_duration_minutes / 60);
                summary.push(`<strong>${hours}</strong> Hours`);
            }
            if (stats.date_range) summary.push(`${stats.date_range.start} to ${stats.date_range.end}`);
            
            $('stats-summary').innerHTML = summary.join(' &nbsp;|&nbsp; ');
        }

        function renderAtAGlance(data) {
            if (!data) return '';
            const items = [
                { label: "What's Working", value: data.whats_working },
                { label: "What's Hindering", value: data.whats_hindering },
                { label: "Quick Wins", value: data.quick_wins },
                { label: "Ambitious Goal", value: data.ambitious_workflows }
            ];

            const gridItems = items.map(item => `
                <div class="glance-item">
                    <div class="glance-label">${item.label}</div>
                    <div class="glance-value">${parseMarkdown(item.value || 'N/A')}</div>
                </div>
            `).join('');

            return renderSection("At a Glance", `<div class="at-a-glance-grid">${gridItems}</div>`);
        }

        function renderProjectAreas(data) {
            if (!data || !data.areas || data.areas.length === 0) return '';
            
            const list = data.areas.map(area => `
                <div class="project-area">
                    <div>
                        <div style="font-weight: 600;">${escapeHtml(area.name)}</div>
                        <div class="text-secondary text-sm">${escapeHtml(area.description)}</div>
                    </div>
                    <div class="area-count">${area.session_count || 0}</div>
                </div>
            `).join('');

            return renderSection("What You Work On", list);
        }

        function renderStyle(data) {
            if (!data) return '';
            let content = '';
            if (data.narrative) content += `<p>${parseMarkdown(data.narrative)}</p>`;
            if (data.key_pattern) content += `<p style="margin-top: 1rem; font-style: italic; color: var(--text-secondary);">Key Pattern: ${parseMarkdown(data.key_pattern)}</p>`;
            
            return renderSection("Your Style", content);
        }

        function renderWhatWorks(data) {
            if (!data || !data.workflows || data.workflows.length === 0) return '';
            
            const list = data.workflows.map(wf => `
                <div style="margin-bottom: 1rem;">
                    <div style="font-weight: 600; color: var(--success-color); margin-bottom: 0.25rem;">✓ ${escapeHtml(wf.title)}</div>
                    <p class="text-secondary">${parseMarkdown(wf.description)}</p>
                </div>
            `).join('');

            return renderSection("What's Working Well", list);
        }

        function renderFriction(data) {
            if (!data || !data.categories || data.categories.length === 0) return '';
            
            const list = data.categories.map(cat => {
                const examples = (cat.examples || []).map(ex => 
                    `<li class="text-sm text-secondary">${escapeHtml(ex.issue)} <span style="opacity: 0.7;">(${escapeHtml(ex.impact)})</span></li>`
                ).join('');
                
                return `
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: var(--warning-color); font-size: 1rem;">${escapeHtml(cat.name)}</h4>
                        <ul class="list-disc">${examples}</ul>
                    </div>
                `;
            }).join('');

            return renderSection("Friction Points", list);
        }

        function renderSuggestions(data) {
            if (!data) return '';
            
            let html = '';
            if (data.features && data.features.length) {
                html += `<h4>Features to Try</h4><ul class="list-disc" style="margin-bottom: 1.5rem;">${data.features.map(f => `<li>${parseMarkdown(f)}</li>`).join('')}</ul>`;
            }
            if (data.usage_patterns && data.usage_patterns.length) {
                html += `<h4>Pattern Shifts</h4><ul class="list-disc">${data.usage_patterns.map(p => `<li>${parseMarkdown(p)}</li>`).join('')}</ul>`;
            }

            return renderSection("Suggestions", html);
        }

        function renderHorizon(data) {
            if (!data || !data.opportunities || data.opportunities.length === 0) return '';
            
            const list = data.opportunities.map(opp => `
                <div style="margin-bottom: 2rem;">
                    <h3 style="margin-top: 0;">${escapeHtml(opp.title)}</h3>
                    <p>${parseMarkdown(opp.description)}</p>
                    ${opp.copyable_prompt ? `<div class="prompt-box">${escapeHtml(opp.copyable_prompt)}</div>` : ''}
                </div>
            `).join('');

            return renderSection("On the Horizon", list);
        }

        function renderFunMoment(data) {
            if (!data) return '';
            return `
                <section style="margin-top: 3rem;">
                    <div class="card fun-moment">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">✨</div>
                            <h3 style="margin: 0; color: var(--accent-color);">${escapeHtml(data.headline || 'Moment of Zen')}</h3>
                            <p style="margin-top: 0.5rem;">${parseMarkdown(data.detail)}</p>
                        </div>
                    </div>
                </section>
            `;
        }

        // --- Main ---
        
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Get Raw Data
                const statsRaw = $('stats-data').textContent.trim();
                const insightsRaw = $('insights-data').textContent.trim();

                let stats = {}, insights = {};

                // Handle Placeholders if file is opened directly without processing
                if (statsRaw && !statsRaw.includes('{{STATS_JSON')) {
                    stats = JSON.parse(statsRaw);
                }
                if (insightsRaw && !insightsRaw.includes('{{INSIGHTS_JSON')) {
                    insights = JSON.parse(insightsRaw);
                }

                // Render
                renderStats(stats);
                
                const htmlParts = [
                    renderAtAGlance(insights.at_a_glance),
                    renderProjectAreas(insights.project_areas),
                    renderStyle(insights.interaction_style),
                    renderWhatWorks(insights.what_works),
                    renderFriction(insights.friction_analysis),
                    renderSuggestions(insights.suggestions),
                    renderHorizon(insights.on_the_horizon),
                    renderFunMoment(insights.fun_ending)
                ];

                $('report-content').innerHTML = htmlParts.join('') || '<div style="text-align:center; color: var(--text-secondary);">No insights data available to display.</div>';

            } catch (e) {
                console.error("Rendering failed", e);
                $('report-content').innerHTML = `<div style="color: red; text-align: center; padding: 2rem;">
                    <h3>Error Generating Report</h3>
                    <p>${e.message}</p>
                </div>`;
            }
        });
    </script>
</body>
</html>